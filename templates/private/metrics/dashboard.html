{% extends 'base.html' %}
{% block title %}Métricas - FacturIA{% endblock %}
{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static "css/dashboard.css" %}" />
<link rel="stylesheet" href="{% static "css/metrics/dashboard.css" %}" />
{% endblock %}

{% block content %}
<div class="container dashboard">

  <div class="dashboard-header">
    <h1>
      <i class="fa-solid fa-chart-line"></i>
      Métricas · <span class="client-name">{{ client.name }}</span>
    </h1>
    <p>Resumen general de actividad y rendimiento</p>
  </div>

  <div class="date-filter">
    <form method="get">
      <label>Desde:</label>
      <input type="date" name="start" value="{{ selected_start|date:'Y-m-d' }}">
      
      <label>Hasta:</label>
      <input type="date" name="end" value="{{ selected_end|date:'Y-m-d' }}">

      <button type="submit" class="btn">Ver</button>
      {% if request.GET %}
        <a href="?" class="btn-clear">Limpiar</a>
      {% endif %}
    </form>
  </div>

  <h2 class="section-title mt-5">
    <i class="section-icon fa-solid fa-calendar-check"></i> 
    Periodo seleccionado
  </h2>
  <small class="section-subtitle">
    {% if today == selected_end %}
      Este mes
    {% elif selected_start_formatted and selected_end_formatted %}
      Desde: {{ selected_start_formatted }} - Hasta: {{ selected_end_formatted }}
    {% endif %}
    </small>
  <div class="dashboard-cards">
    <div class="card">
      <h3>Ingresos</h3>
      <span class="kpi text-success">
        {{ financials.income|floatformat:2 }} €
      </span>
    </div>

    <div class="card">
      <h3>Gastos</h3>
      <span class="kpi text-danger">
        {{ financials.expense|floatformat:2 }} €
      </span>
    </div>

    <div class="card">
      <h3>Beneficio</h3>
      <span class="kpi {% if financials.profit >= 0 %}text-success{% else %}text-danger{% endif %}">
        {{ financials.profit|floatformat:2 }} €
      </span>
    </div>

    <div class="card">
      <h3>Documentos</h3>
      <span class="kpi">
        {{ documents.total }}
      </span>
      <small class="kpi-info">
        <span class="dot"></span>
        <strong>{{ documents.approved }}</strong> aprobados
      </small>
    </div>
  </div>
    
    <h2 class="section-title mt-5"><i class="section-icon fa-solid fa-file-invoice"></i> Facturación</h2>
    <small class="section-subtitle">Solo facturas aprobadas · Abonos descontados</small>
    <div class="chart-container line-chart">
      <h3 class="chart-title">Ingresos vs Gastos</h3>
      <canvas id="incomeExpenseChart"></canvas>
    </div>
    
    <div class="automation-header">
      <h2 class="section-title mt-5">
        <i class="section-icon fa-solid fa-gears"></i>
        Automatización
      </h2>
      <small class="section-subtitle">
        Rendimiento del sistema de revisión inteligente
      </small>
    </div>
    <div class="automation-section">
      <div class="chart-container donut-chart">
        <h3 class="chart-title">Distribución de decisiones</h3>
        <canvas id="autoApprovalChart"></canvas>
      </div>
  
      <div class="dashboard-cards">
        <div class="card">
          <h3>Confianza media de extracción</h3>
          <span class="kpi text-success">
            {{ documents.confidence_average|floatformat:1 }} %
          </span>
        </div>
  
        <div class="card">
          <h3>Tasa aprobación automática</h3>
          <span class="kpi text-success">
            {{ documents.auto_approval_rate|floatformat:1 }} %
          </span>
        </div>
  
        <div class="card">
          <h3>Tasa revisión manual</h3>
          <span class="kpi text-info">
            {{ documents.manual_approval_rate|floatformat:1 }} %
          </span>
        </div>
      </div>
    </div>
  
    <h2 class="section-title mt-4"><i class="section-icon fa-solid fa-chart-column"></i> Actividad de documentos</h2>
    <small class="section-subtitle">En el periodo seleccionado</small>
    <div class="dashboard-cards">
      <div class="card">
        <a href="{% url 'documents:list' %}">
          <h3>Total documentos</h3>
          <span class="kpi">{{ documents.total|default:0 }}</span>
        </a>
      </div>

      <div class="card">
        <a href="{% url 'documents:list' %}?status=approved">
          <h3>Aprobados</h3>
          <span class="kpi text-success">
            {{ documents.approved|default:0 }}
          </span>
        </a>
      </div>
  
      <div class="card">
        <a href="{% url 'documents:list' %}?status=pending">
          <h3>Pendientes</h3>
          <span class="kpi text-warning">
            {{ documents.pending|default:0 }}
          </span>
        </a>
      </div>
  
      <div class="card">
        <a href="{% url 'documents:list' %}?status=rejected">
          <h3>Rechazados</h3>
          <span class="kpi text-danger">
            {{ documents.rejected|default:0 }}
          </span>
        </a>
      </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ====== Preparar datos para Chart.js ======
  const rawData = {{ charts.income_expense_monthly|safe }};

  // Labels y datos
  const labels = rawData.map(item => item.period); // "1 Feb", "Feb 2026", etc.
  const incomeData = rawData.map(item => item.income);
  const expenseData = rawData.map(item => item.expense);
  const profitData = rawData.map(item => item.profit); // opcional para línea de beneficio

  new Chart(document.getElementById('incomeExpenseChart'), {
      type: 'line',
      data: {
          labels: labels,
          datasets: [
              {
                  label: 'Ingresos',
                  data: incomeData,
                  borderColor: '#22c55e',
                  backgroundColor: 'rgba(34,197,94,0.1)',
                  tension: 0.4,
                  fill: true
              },
              {
                  label: 'Gastos',
                  data: expenseData,
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239,68,68,0.1)',
                  tension: 0.4,
                  fill: true
              },
              // Línea opcional de beneficio
              {
                  label: 'Beneficio',
                  data: profitData,
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59,130,246,0.1)',
                  tension: 0.4,
                  fill: true,
                  borderDash: [5, 5]
              }
          ]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { position: 'top' },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} €`;
                      }
                  }
              }
          },
          scales: {
              y: { beginAtZero: true },
              x: { ticks: { autoSkip: false } }
          }
      }
  });

  // ====== Gráfico Distribución de estados ======
  const statusData = {{ status_distribution|safe }};
  const statusLabels = Object.keys(statusData);

  const statusLabelsFormatted = statusLabels.map(label => {
    switch (label) {
      case 'auto_approved':
          return 'Aprobados (auto)';
      case 'pending':
          return 'Pendientes';
      case 'rejected':
          return 'Rechazados';
      case 'manual_approved':
          return 'Aprobados (manual)';
      default:
          return label;
    }
  })

  const statusValues = Object.values(statusData);

  const ctx = document.getElementById('autoApprovalChart');
  const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
          labels: statusLabelsFormatted,
          datasets: [{
              data: statusValues,
              backgroundColor: ['#22c55e', '#ef4444', '#6c757d', '#3b82f6'],
              borderWidth: 1,
              cutout: '65%',
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          const value = context.parsed;
                          const total = context.dataset.data.reduce((a,b)=>a+b,0);
                          const percentage = ((value/total)*100).toFixed(1);
                          return `${context.label}: ${value} (${percentage}%)`;
                      }
                  }
              }
          }
      }
  });

  // Div central dinámico para doughnut
  ctx.parentNode.style.position = 'relative';
  const centerDiv = document.createElement('div');
  centerDiv.style.position = 'absolute';
  centerDiv.style.top = '50%';
  centerDiv.style.left = '50%';
  centerDiv.style.transform = 'translate(-50%, -50%)';
  centerDiv.style.fontSize = '1rem';
  centerDiv.style.fontWeight = '600';
  centerDiv.style.color = '#f8fafc';
  centerDiv.style.pointerEvents = 'none';
  ctx.parentNode.appendChild(centerDiv);

  function updateCenterText(activeIndex = null) {
      let total;
      if (activeIndex !== null) {
          total = chart.data.datasets[0].data[activeIndex];
          const label = chart.data.labels[activeIndex];
          centerDiv.innerText = `${total} ${label}`;
      } else {
          total = chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
          centerDiv.innerText = `${total} documentos`;
      }
  }
  updateCenterText();
  ctx.addEventListener('mousemove', (evt) => {
      const points = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
      if (points.length) updateCenterText(points[0].index);
      else updateCenterText();
  });
</script>
{% endblock %}

