{% extends "base.html" %}
{% block title %}Ver documento - FacturIA{% endblock %}
{% block styles %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/documents/document_detail.css' %}">
{% endblock %}

{% block content %}
<div class="layout">

    <!-- Panel PDF -->
    <div class="pdf">
        <div class="pdf-header">
            <h3>{{ document.original_name }}</h3>
            
            <div class="pdf-badges">
                <span class="badge type">{{ document.get_document_type_display }}</span>
                <span class="badge status status-{{ document.status }}">
                    {{ document.get_status_display }}
                </span>
            </div>
        </div>
        
        {% if document.is_pdf %}
        <div class="pdf-toolbar">
            <button id="prev-page">â—€</button>
            <span>Pagina <span id="page-num"></span> / <span id="page-count"></span></span>
            <button id="next-page">â–¶</button>
            <button id="zoom-in">+</button>
            <button id="zoom-out">-</button>
        </div>
        {% endif %}

        {% if document.is_pdf %}
            <div id="pdf-viewer" style="width:100%; height:600px; overflow:auto;"></div>
            <p id="pdf-fallback" style="display:none;">
                No se puede visualizar el PDF.
                <a href="{{ document.file.url }}" target="_blank">Descargar PDF</a>
            </p>
        {% elif document.is_image %}
            <img src="{{ document.file.url }}" style="max-width:100%;" />
        {% else %}
            <p>No se puede visualizar el archivo</p>
        {% endif %}
    </div>
    <!-- Panel de datos con revisiÃ³n editable -->
    <div class="data-form">
        <form method="post" id="review-form">
            {% csrf_token %}
            <div class="data">
                <!-- Datos para el modal -->
                <div id="doc-data" hidden
                    data-name="{{ document.original_name }}"
                    data-type="{{ document.get_document_type_display }}"
                    data-total-amount="{{ document.total_amount }}"
                >
                </div>
    
                <!-- Proveedor -->
                <div class="field">
                    <span class="label">Proveedor</span>
                    <span class="value">{{ document.company.name }}</span>
                    {% comment %} {% if document.is_editable %}
                        <input type="text" name="company_name" value="{{ document.company.name }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.company.name }}</span>
                    {% endif %} {% endcomment %}
                </div>
    
                <!-- CIF/NIF -->
                {% comment %} <div class="field">
                    <span class="label">CIF/NIF</span>
                    {% if document.is_editable %}
                        <input type="text" name="company_tax_id" value="{{ document.company.tax_id }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.company.tax_id }}</span>
                    {% endif %}
                </div> {% endcomment %}

                <!-- Compra o Venta-->
                <div class="field">
                    <span class="label">Flujo</span>
                    {% if document.is_editable %}
                        <select name="flow" class="editable-field">
                            <option value="in" {% if document.flow == "in" %}selected{% endif %}>Venta</option>
                            <option value="out" {% if document.flow == "out" %}selected{% endif %}>Compra</option>
                        </select>
                    {% else %}
                        <span class="value">{{ document.get_flow_display }}</span>
                    {% endif %}
                </div>

                <!-- Numero factura-->
                <div class="field">
                    <span class="label">NÂ° Documento</span>
                    {% if document.is_editable %}
                        <input type="text" name="document_number" value="{{ document.document_number }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.document_number }}</span>
                    {% endif %}
                </div>
    
                <!-- Fecha -->
                <div class="field">
                    <span class="label">Fecha</span>
                    {% if document.is_editable %}
                        <input type="date" name="issue_date" value="{{ document.issue_date|date:'Y-m-d' }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.issue_date|date:"d/m/Y" }}</span>
                    {% endif %}
                </div>
    
                <!-- Base -->
                <div class="field">
                    <span class="label">Base</span>
                    {% if document.is_editable %}
                        <input type="text" inputmode="decimal" step="0.01" name="base_amount" value="{{ document.base_amount }}" class="editable-field">
                    {% else %}
                        <span class="value">{% if document.base_amount %}{{ document.base_amount }} â‚¬{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
    
                <!-- CÃ¡lculo IVA -->
                <div class="field">
                    {% if document.is_editable %}
                    <span class="label">% / Total IVA</span>
                    <div class="iva-fields">
                        <input type="text" inputmode="decimal" step="0.01" name="tax_percentage" value="{{ document.tax_percentage|floatformat:2 }}" class="editable-field decimal-field" placeholder="IVA %"><span>%</span>
                        <input type="text" inputmode="decimal" step="0.01" name="tax_amount" value="{{ document.tax_amount|floatformat:2 }}" class="editable-field decimal-field" placeholder="IVA â‚¬"><span>â‚¬</span>
                    </div>
                    {% else %}
                    <span class="label">CÃ¡lculo IVA</span>
                    <span class="value">
                            {% if document.base_amount and document.tax_percentage and document.tax_amount %}
                                {{ document.base_amount|floatformat:2 }} Ã— {{ document.tax_percentage|floatformat:2 }}% = {{ document.tax_amount|floatformat:2 }} â‚¬
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
    
                <!-- Total -->
                <div class="field">
                    <span class="label">Total</span>
                    {% if document.is_editable %}
                        <input type="text" inputmode="decimal" step="0.01" name="total_amount" value="{{ document.total_amount }}" class="editable-field decimal-field">
                    {% else %}
                        <span class="value">{% if document.total_amount %}{{ document.total_amount }} â‚¬{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            <!-- Acciones -->
            <div class="actions">
                <!-- Revision aprobado o rechazar -->
                {% if document.status == "pending" %}
                    <button type="submit" name="action" value="save" class="btn btn-save">
                        Guardar <i class="fa-solid fa-floppy-disk"></i>
                    </button>
                    <button type="button" class="btn btn-approve confirm-action" data-action="approve">
                        Aprobar <i class="fa-solid fa-check"></i>
                    </button>
                    <button type="button" class="btn btn-reject confirm-action" data-action="reject">
                        Rechazar <i class="fa-solid fa-xmark"></i>
                    </button>
                {% endif %}
                {% if document.status in "approved rejected" and not document.is_archived %}
                    <button type="button" class="btn btn-archive confirm-action" data-action="archive">
                        Archivar <i class="fa-solid fa-archive"></i>
                    </button>
                {% endif %}
                {% if document.is_archived %}
                    <button type="button" class="btn btn-unarchive confirm-action" data-action="unarchive">
                        Desarchivar <i class="fa-solid fa-archive"></i>
                    </button>    
                {% endif %}
            </div>
            
            <div class="review_info">
                <span class="label">Estado del documento</span>
                <span class="content">{{ document.status_message }}</span>
            
                <span class="label">Nivel de confianza</span>
                {% if document.review_level == "required" %}
                <span class="content">
                    RevisiÃ³n obligatoria. Los datos extraÃ­dos pueden ser incorrectos.
                </span>
                {% elif document.review_level == "recommended" %}
                <span class="content">
                    RevisiÃ³n recomendada. Algunos campos podrÃ­an no ser exactos.
                </span>
                {% else %}
                <span class="content">
                    Alta confianza. Los datos extraÃ­dos son consistentes.
                </span>
                {% endif %}
            </div>
        </form>

        <div class="modal" id="confirm-modal">
        <div class="modal-backdrop" data-close></div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3 id="modal-title">
                    Confirmar acciÃ³n
                </h3>
            </div>
            <div class="modal-body">
                <div id="modal-doc-info"></div>
                <p id="modal-text">Â¿Seguro que quieres continuar?</p>
                <textarea id="modal-reason" placeholder="Motivo (opcional)">
                    
                </textarea>
            </div>

            <button id="modal-confirm" class="btn btn-primary">
            Confirmar
            </button>
            <button type="button" class="btn btn-light" data-close>
            Cancelar
            </button>
        </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const url = "{{ document.file.url }}";
        const container = document.getElementById('pdf-viewer');
        const fallback = document.getElementById('pdf-fallback');

        if (!container) {
            console.warn("pdf-viewer no existe en este layout");
            return;
        }

        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.2;

        pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js";
                    
        function renderPage(num) {
            if (!pdfDoc) return;

            pdfDoc.getPage(num).then(page => {

                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                container.innerHTML = '';
                container.appendChild(canvas);

                page.render({ canvasContext: ctx, viewport: viewport });

                const pageNumEl = document.getElementById('page-num');
                const pageCountEl = document.getElementById('page-count');

                if (pageNumEl) pageNumEl.textContent = pageNum;
                if (pageCountEl) pageCountEl.textContent = pdfDoc.numPages;

            }).catch(err => {
                console.error("Error renderizando pÃ¡gina:", err);
            });
        }

        function loadPDF() {
            pdfjsLib.getDocument({ url: url}).promise
                .then(pdf => {
                    pdfDoc = pdf;
                    renderPage(pageNum);
                })
                .catch(err => {
                    console.warn("No es un PDF vÃ¡lido, mostrando imagen:", err);
                    showImage();
                });
        }

        function showImage() {
            container.innerHTML = `
                <img src="${url}" style="max-width:100%; height:auto;" />
            `;
        }

        // Detectar extensiÃ³n
        const extension = url.split('.').pop().toLowerCase();

        if (extension === "pdf") {
            loadPDF();
        } else {
            showImage();
        }

        // Toolbar events (protegidos)
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (pageNum > 1) {
                    pageNum--;
                    renderPage(pageNum);
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                if (pdfDoc && pageNum < pdfDoc.numPages) {
                    pageNum++;
                    renderPage(pageNum);
                }
            });
        }

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', () => {
                scale += 0.2;
                renderPage(pageNum);
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', () => {
                scale = Math.max(0.2, scale - 0.2);
                renderPage(pageNum);
            });
        }

    });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const baseInput = document.querySelector('input[name="base_amount"]');
        const taxPercentageInput = document.querySelector('input[name="tax_percentage"]');
        const taxAmountInput = document.querySelector('input[name="tax_amount"]');
        const totalInput = document.querySelector('input[name="total_amount"]');

        if (!baseInput || !taxPercentageInput || !taxAmountInput || !totalInput) return;

        function parseNumber(value) {
            if (!value) return 0;
            value = value.replace(",", ".");
            return parseFloat(value) || 0;
        }

        function formatNumber(value) {
            return value.toFixed(2);
        }

        function calculateFromPercentage() {
            const base = parseNumber(baseInput.value);
            const percentage = parseNumber(taxPercentageInput.value);

            const tax = base * (percentage / 100);
            const total = base + tax;

            taxAmountInput.value = formatNumber(tax);
            totalInput.value = formatNumber(total);
        }

        function calculateFromTaxAmount() {
            const base = parseNumber(baseInput.value);
            const tax = parseNumber(taxAmountInput.value);

            if (base === 0) return;

            const percentage = (tax / base) * 100;
            const total = base + tax;

            taxPercentageInput.value = formatNumber(percentage);
            totalInput.value = formatNumber(total);
        }

        function calculateFromBase() {
            const base = parseNumber(baseInput.value);
            const percentage = parseNumber(taxPercentageInput.value);

            const tax = base * (percentage / 100);
            const total = base + tax;

            taxAmountInput.value = formatNumber(tax);
            totalInput.value = formatNumber(total);
        }

        taxPercentageInput.addEventListener("input", calculateFromPercentage);
        taxAmountInput.addEventListener("input", calculateFromTaxAmount);
        baseInput.addEventListener("input", calculateFromBase);

    });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("confirm-modal");
        const confirmBtn = document.getElementById("modal-confirm");
        const form = document.getElementById("review-form");
        
        let currentAction = null;
        
        document.querySelectorAll(".confirm-action").forEach(btn => {
        btn.addEventListener("click", function () {
            currentAction = this.dataset.action;

            const docData = document.getElementById("doc-data");
            const docName = docData.dataset.name;
            const docType = docData.dataset.type;
            const docTotalAmount = docData.dataset.totalAmount;


            const docDataContent = `
                <div class="modal-doc-summary">
                    <strong>${docName}</strong>
                    <div class="meta">
                    ${docType} Â· ${docTotalAmount} â‚¬
                    </div>
                </div>
            `;


            const icon = document.querySelector(".modal-icon i");
            const docInfo = document.getElementById("modal-doc-info");
            const title = document.getElementById("modal-title");
            const text = document.getElementById("modal-text");
            const confirmBtn = document.getElementById("modal-confirm");

            // ðŸ‘‰ Siempre mostrar info del documento
            docInfo.innerHTML = docDataContent;

            switch (currentAction) {
                case "approve":
                    icon.className = "fa-solid fa-circle-check";
                    icon.style.color = "var(--color-success)";
                    title.textContent = "Confirmar aprobaciÃ³n";
                    text.textContent = "El documento se marcarÃ¡ como aprobado.";
                    confirmBtn.textContent = "Aprobar";
                    confirmBtn.style.color = "var(--color-success)";
                    break;
                case "reject":
                    icon.className = "fa-solid fa-circle-xmark";
                    icon.style.color = "var(--color-danger)";
                    title.textContent = "Confirmar rechazo";
                    text.textContent = "El documento se marcarÃ¡ como rechazado.";
                    confirmBtn.textContent = "Rechazar";
                    confirmBtn.style.color = "var(--color-danger)";    
                    break;
                case "archive":
                    icon.className = "fa-solid fa-box-archive";
                    icon.style.color = "var(--color-warning)";
                    title.textContent = "Confirmar archivo";
                    text.textContent = "El documento serÃ¡ archivado.";
                    confirmBtn.textContent = "Archivar";
                    confirmBtn.style.color = "var(--color-warning)";
                    break;
                case "unarchive":
                    icon.className = "fa-solid fa-box-archive";
                    icon.style.color = "var(--color-warning)";
                    title.textContent = "Confirmar desarchivo";
                    text.textContent = "El documento volverÃ¡ a estar activo.";
                    confirmBtn.textContent = "Desarchivar";
                    confirmBtn.style.color = "var(--color-warning)";
                    break;
                default:
                    break;
            }

            modal.classList.add("open");
        });
    });

        confirmBtn.addEventListener("click", function () {
            if (!currentAction) return;

            // Crear input hidden dinÃ¡micamente
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "action";
            hiddenInput.value = currentAction;

            form.appendChild(hiddenInput);
            form.submit();
        });

        document.querySelectorAll("[data-close]").forEach(btn => {
            btn.addEventListener("click", function () {
            modal.classList.remove("open");
            });
        });

        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
            modal.classList.remove("open");
            }
        });

    });
    </script>

{% endblock %}