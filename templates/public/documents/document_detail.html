{% extends "base.html" %}
{% block title %}Ver documento - FacturIA{% endblock %}
{% block styles %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/documents/document_detail.css' %}">
{% endblock %}

{% block content %}
<div class="layout">

    <!-- Panel PDF -->
    <div class="pdf">
        <div class="pdf-header">
            <h3>{{ document.original_name }}</h3>
            
            <div class="pdf-badges">
                <span class="badge type">{{ document.get_document_type_display }}</span>
                <span class="badge status status-{{ document.status }}">
                    {{ document.get_status_display }}
                </span>
            </div>
        </div>
        
        {% if document.is_pdf %}
        <div class="pdf-toolbar">
            <button id="prev-page">◀</button>
            <span>Pagina <span id="page-num"></span> / <span id="page-count"></span></span>
            <button id="next-page">▶</button>
            <button id="zoom-in">+</button>
            <button id="zoom-out">-</button>
        </div>
        {% endif %}

        {% if document.is_pdf %}
            <div id="pdf-viewer" style="width:100%; height:600px; overflow:auto;"></div>
            <p id="pdf-fallback" style="display:none;">
                No se puede visualizar el PDF.
                <a href="{{ document.file.url }}" target="_blank">Descargar PDF</a>
            </p>
        {% elif document.is_image %}
            <img src="{{ document.file.url }}" style="max-width:100%;" />
        {% else %}
            <p>No se puede visualizar el archivo</p>
        {% endif %}
    </div>
    <!-- Panel de datos con revisión editable -->
    <div class="data-form">
        <form method="post" id="review-form">
            {% csrf_token %}
            <div class="data">
    
                <!-- Proveedor -->
                <div class="field">
                    <span class="label">Proveedor</span>
                    <span class="value">{{ document.company.name }}</span>
                    {% comment %} {% if document.is_editable %}
                        <input type="text" name="company_name" value="{{ document.company.name }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.company.name }}</span>
                    {% endif %} {% endcomment %}
                </div>
    
                <!-- CIF/NIF -->
                {% comment %} <div class="field">
                    <span class="label">CIF/NIF</span>
                    {% if document.is_editable %}
                        <input type="text" name="company_tax_id" value="{{ document.company.tax_id }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.company.tax_id }}</span>
                    {% endif %}
                </div> {% endcomment %}

                <!-- Compra o Venta-->
                <div class="field">
                    <span class="label">Flujo</span>
                    {% if document.is_editable %}
                        <select name="flow" class="editable-field">
                            <option value="in" {% if document.flow == "in" %}selected{% endif %}>Compra</option>
                            <option value="out" {% if document.flow == "out" %}selected{% endif %}>Venta</option>
                        </select>
                    {% else %}
                        <span class="value">{{ document.get_flow_display }}</span>
                    {% endif %}
                </div>

                <!-- Numero factura-->
                <div class="field">
                    <span class="label">N° Documento</span>
                    {% if document.is_editable %}
                        <input type="text" name="document_number" value="{{ document.document_number }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.document_number }}</span>
                    {% endif %}
                </div>
    
                <!-- Fecha -->
                <div class="field">
                    <span class="label">Fecha</span>
                    {% if document.is_editable %}
                        <input type="date" name="issue_date" value="{{ document.issue_date|date:'Y-m-d' }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.issue_date|date:"d/m/Y" }}</span>
                    {% endif %}
                </div>
    
                <!-- Base -->
                <div class="field">
                    <span class="label">Base</span>
                    {% if document.is_editable %}
                        <input type="text" inputmode="decimal" step="0.01" name="base_amount" value="{{ document.base_amount }}" class="editable-field">
                    {% else %}
                        <span class="value">{% if document.base_amount %}{{ document.base_amount }} €{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
    
                <!-- Cálculo IVA -->
                <div class="field">
                    {% if document.is_editable %}
                    <span class="label">% / Total IVA</span>
                    <div class="iva-fields">
                        <input type="text" inputmode="decimal" step="0.01" name="tax_percentage" value="{{ document.tax_percentage|floatformat:2 }}" class="editable-field decimal-field" placeholder="IVA %"><span>%</span>
                        <input type="text" inputmode="decimal" step="0.01" name="tax_amount" value="{{ document.tax_amount|floatformat:2 }}" class="editable-field decimal-field" placeholder="IVA €"><span>€</span>
                    </div>
                    {% else %}
                    <span class="label">Cálculo IVA</span>
                    <span class="value">
                            {% if document.base_amount and document.tax_percentage and document.tax_amount %}
                                {{ document.base_amount|floatformat:2 }} × {{ document.tax_percentage|floatformat:2 }}% = {{ document.tax_amount|floatformat:2 }} €
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
    
                <!-- Total -->
                <div class="field">
                    <span class="label">Total</span>
                    {% if document.is_editable %}
                        <input type="text" inputmode="decimal" step="0.01" name="total_amount" value="{{ document.total_amount }}" class="editable-field decimal-field">
                    {% else %}
                        <span class="value">{% if document.total_amount %}{{ document.total_amount }} €{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            <!-- Acciones -->
            <div class="actions">
                <!-- Revision aprobado o rechazar -->
                {% if document.status == "pending" %}
                    <button type="submit" name="action" value="save" class="btn btn-save">Guardar <i class="fa-solid fa-floppy-disk"></i></button>
                    <button type="submit" name="action" value="approve" class="btn btn-approve">Aprobar <i class="fa-solid fa-check"></i></button>
                    <button type="submit" name="action" value="reject" class="btn btn-reject">Rechazar <i class="fa-solid fa-xmark"></i></button>
                {% endif %}
                {% if document.status in "approved rejected" and not document.is_archived %}
                    <button type="submit" name="action" value="archive" class="btn btn-archive">
                        Archivar <i class="fa-solid fa-archive"></i>
                    </button>
                {% endif %}
                {% if document.is_archived %}
                    <button type="submit" name="action" value="unarchive" class="btn btn-unarchive">
                        Desarchivar <i class="fa-solid fa-archive"></i>
                    </button>    
                {% endif %}
            </div>
            
            <div class="review_info">
                <span class="label">Estado del documento</span>
                <span class="content">{{ document.status_message }}</span>
            
                <span class="label">Nivel de confianza</span>
                {% if document.review_level == "required" %}
                <span class="content">
                    Revisión obligatoria. Los datos extraídos pueden ser incorrectos.
                </span>
                {% elif document.review_level == "recommended" %}
                <span class="content">
                    Revisión recomendada. Algunos campos podrían no ser exactos.
                </span>
                {% else %}
                <span class="content">
                    Alta confianza. Los datos extraídos son consistentes.
                </span>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const url = "{{ document.file.url }}";
        const container = document.getElementById('pdf-viewer');
        const fallback = document.getElementById('pdf-fallback');

        if (!container) {
            console.warn("pdf-viewer no existe en este layout");
            return;
        }

        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.2;

        pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js";
                    
        function renderPage(num) {
            if (!pdfDoc) return;

            pdfDoc.getPage(num).then(page => {

                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                container.innerHTML = '';
                container.appendChild(canvas);

                page.render({ canvasContext: ctx, viewport: viewport });

                const pageNumEl = document.getElementById('page-num');
                const pageCountEl = document.getElementById('page-count');

                if (pageNumEl) pageNumEl.textContent = pageNum;
                if (pageCountEl) pageCountEl.textContent = pdfDoc.numPages;

            }).catch(err => {
                console.error("Error renderizando página:", err);
            });
        }

        function loadPDF() {
            pdfjsLib.getDocument({ url: url}).promise
                .then(pdf => {
                    pdfDoc = pdf;
                    renderPage(pageNum);
                })
                .catch(err => {
                    console.warn("No es un PDF válido, mostrando imagen:", err);
                    showImage();
                });
        }

        function showImage() {
            container.innerHTML = `
                <img src="${url}" style="max-width:100%; height:auto;" />
            `;
        }

        // Detectar extensión
        const extension = url.split('.').pop().toLowerCase();

        if (extension === "pdf") {
            loadPDF();
        } else {
            showImage();
        }

        // Toolbar events (protegidos)
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (pageNum > 1) {
                    pageNum--;
                    renderPage(pageNum);
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                if (pdfDoc && pageNum < pdfDoc.numPages) {
                    pageNum++;
                    renderPage(pageNum);
                }
            });
        }

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', () => {
                scale += 0.2;
                renderPage(pageNum);
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', () => {
                scale = Math.max(0.2, scale - 0.2);
                renderPage(pageNum);
            });
        }

    });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const baseInput = document.querySelector('input[name="base_amount"]');
        const taxPercentageInput = document.querySelector('input[name="tax_percentage"]');
        const taxAmountInput = document.querySelector('input[name="tax_amount"]');
        const totalInput = document.querySelector('input[name="total_amount"]');

        if (!baseInput || !taxPercentageInput || !taxAmountInput || !totalInput) return;

        function parseNumber(value) {
            if (!value) return 0;
            value = value.replace(",", ".");
            return parseFloat(value) || 0;
        }

        function formatNumber(value) {
            return value.toFixed(2);
        }

        function calculateFromPercentage() {
            const base = parseNumber(baseInput.value);
            const percentage = parseNumber(taxPercentageInput.value);

            const tax = base * (percentage / 100);
            const total = base + tax;

            taxAmountInput.value = formatNumber(tax);
            totalInput.value = formatNumber(total);
        }

        function calculateFromTaxAmount() {
            const base = parseNumber(baseInput.value);
            const tax = parseNumber(taxAmountInput.value);

            if (base === 0) return;

            const percentage = (tax / base) * 100;
            const total = base + tax;

            taxPercentageInput.value = formatNumber(percentage);
            totalInput.value = formatNumber(total);
        }

        function calculateFromBase() {
            const base = parseNumber(baseInput.value);
            const percentage = parseNumber(taxPercentageInput.value);

            const tax = base * (percentage / 100);
            const total = base + tax;

            taxAmountInput.value = formatNumber(tax);
            totalInput.value = formatNumber(total);
        }

        taxPercentageInput.addEventListener("input", calculateFromPercentage);
        taxAmountInput.addEventListener("input", calculateFromTaxAmount);
        baseInput.addEventListener("input", calculateFromBase);

    });
    </script>


{% endblock %}