{% extends "base.html" %}
{% block title %}Documentos - FacturIA{% endblock %}
{% block styles %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/documents/document_detail.css' %}">
{% endblock %}

{% block content %}
<div class="layout">

    <!-- Panel PDF -->
    <div class="pdf">
        <div class="pdf-header">
            <h3>{{ document.original_name }}</h3>
            
            <div class="pdf-badges">
                <span class="badge type">{{ document.get_document_type_display }}</span>
                <span class="badge status status-{{ document.status }}">
                    {{ document.get_status_display }}
                </span>
            </div>
        </div>
        
        {% if document.is_pdf %}
        <div class="pdf-toolbar">
            <button id="prev-page">◀</button>
            <span>Pagina <span id="page-num"></span> / <span id="page-count"></span></span>
            <button id="next-page">▶</button>
            <button id="zoom-in">+</button>
            <button id="zoom-out">-</button>
        </div>
        {% endif %}

        {% if document.is_pdf %}
            <div id="pdf-viewer" style="width:100%; height:600px; overflow:auto;"></div>
            <p id="pdf-fallback" style="display:none;">
                No se puede visualizar el PDF.
                <a href="{{ document.file.url }}" target="_blank">Descargar PDF</a>
            </p>
        {% elif document.is_image %}
            <img src="{{ document.file.url }}" style="max-width:100%;" />
        {% else %}
            <p>No se puede visualizar el archivo</p>
        {% endif %}
    </div>
    <!-- Panel de datos con revisión editable -->
    <div class="data-form">
        <form method="post" id="review-form">
            {% csrf_token %}
            <div class="data">
    
                <!-- Proveedor -->
                <div class="field">
                    <span class="label">Proveedor</span>
                    <span class="value">{{ document.company.name }}</span>
                    {% comment %} {% if document.is_editable %}
                        <input type="text" name="company_name" value="{{ document.company.name }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.company.name }}</span>
                    {% endif %} {% endcomment %}
                </div>
    
                <!-- CIF/NIF -->
                {% comment %} <div class="field">
                    <span class="label">CIF/NIF</span>
                    {% if document.is_editable %}
                        <input type="text" name="company_tax_id" value="{{ document.company.tax_id }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.company.tax_id }}</span>
                    {% endif %}
                </div> {% endcomment %}

                <!-- Compra o Venta-->
                <div class="field">
                    <span class="label">Flujo</span>
                    {% if document.is_editable %}
                        <select name="flow" class="editable-field">
                            <option value="in" {% if document.flow == "in" %}selected{% endif %}>Compra</option>
                            <option value="out" {% if document.flow == "out" %}selected{% endif %}>Venta</option>
                        </select>
                    {% else %}
                        <span class="value">{{ document.get_flow_display }}</span>
                    {% endif %}
                </div>

                <!-- Numero factura-->
                <div class="field">
                    <span class="label">N° Documento</span>
                    {% if document.is_editable %}
                        <input type="text" name="document_number" value="{{ document.document_number }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.document_number }}</span>
                    {% endif %}
                </div>
    
                <!-- Fecha -->
                <div class="field">
                    <span class="label">Fecha</span>
                    {% if document.is_editable %}
                        <input type="date" name="issue_date" value="{{ document.issue_date|date:'Y-m-d' }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.issue_date|date:"d/m/Y" }}</span>
                    {% endif %}
                </div>
    
                <!-- Base -->
                <div class="field">
                    <span class="label">Base</span>
                    {% if document.is_editable %}
                        <input type="number" step="0.01" name="base_amount" value="{{ document.base_amount }}" class="editable-field">
                    {% else %}
                        <span class="value">{% if document.base_amount %}{{ document.base_amount }} €{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
    
                <!-- Cálculo IVA -->
                <div class="field">
                    {% if document.is_editable %}
                    <span class="label">% / Total IVA</span>
                    <div class="iva-fields">
                        <input type="number" step="0.01" name="tax_percentage" value="{{ document.tax_percentage }}" class="editable-field" placeholder="IVA %"><span>%</span>
                        <input type="number" step="0.01" name="tax_amount" value="{{ document.tax_amount }}" class="editable-field" placeholder="IVA €"><span>€</span>
                    </div>
                    {% else %}
                    <span class="label">Cálculo IVA</span>
                    <span class="value">
                            {% if document.base_amount and document.tax_percentage and document.tax_amount %}
                                {{ document.base_amount }} × {{ document.tax_percentage }}% = {{ document.tax_amount }} €
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
    
                <!-- Total -->
                <div class="field">
                    <span class="label">Total</span>
                    {% if document.is_editable %}
                        <input type="number" step="0.01" name="total_amount" value="{{ document.total_amount }}" class="editable-field">
                    {% else %}
                        <span class="value">{% if document.total_amount %}{{ document.total_amount }} €{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            <!-- Acciones -->
            <div class="actions">
                <!-- Revision aprobado o rechazar -->
                {% if document.status == "pending" %}
                    <button type="submit" name="action" value="save" class="btn-save">Guardar cambios</button>
                    <button type="submit" name="action" value="approve" class="btn-approve">Aprobar</button>
                    <button type="submit" name="action" value="reject" class="btn-reject">Rechazar</button>
                {% endif %}
            </div>
            
            <div class="review_info">
                <span class="label">Estado del documento</span>
                <span class="content">{{ document.status_message }}</span>
            
                <span class="label">Nivel de confianza</span>
                {% if document.review_level == "required" %}
                <span class="content">
                    Revisión obligatoria. Los datos extraídos pueden ser incorrectos.
                </span>
                {% elif document.review_level == "recommended" %}
                <span class="content">
                    Revisión recomendada. Algunos campos podrían no ser exactos.
                </span>
                {% else %}
                <span class="content">
                    Alta confianza. Los datos extraídos son consistentes.
                </span>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <script>
        const url = "{{ document.file.url }}";
        const container = document.getElementById('pdf-viewer');
        const fallback = document.getElementById('pdf-fallback');
        let pdfDoc = null, pageNum = 1; scale = 1.2;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Limpia container
                container.innerHTML = '';
                container.appendChild(canvas);

                page.render({ canvasContext: ctx, viewport: viewport });

                document.getElementById('page-num').textContent = pageNum;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
            });
        }

        pdfjsLib.getDocument(url).promise.then(pdf => {
            pdfDoc = pdf;
            renderPage(pageNum);
        });

        // Toolbar events
        document.getElementById('prev-page').onclick = () => { if(pageNum>1){ pageNum--; renderPage(pageNum); } };
        document.getElementById('next-page').onclick = () => { if(pageNum<pdfDoc.numPages){ pageNum++; renderPage(pageNum); } };
        document.getElementById('zoom-in').onclick = () => { scale+=0.2; renderPage(pageNum); };
        document.getElementById('zoom-out').onclick = () => { scale=Math.max(0.2, scale-0.2); renderPage(pageNum); };
    </script>
{% endblock %}