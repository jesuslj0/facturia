{% extends "base.html" %}
{% block title %}Documentos - Billing AI{% endblock %}
{% block styles %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/documents/document_detail.css' %}">
{% endblock %}

{% block content %}
<div class="layout">

    <!-- Panel PDF -->
    <div class="pdf">
        <div class="pdf-header">
            <h3>{{ document.original_name }}</h3>
            
            <div class="pdf-badges">
                <span class="badge type">{{ document.get_document_type_display }}</span>
                <span class="badge status status-{{ document.status }}">
                    {{ document.get_status_display }}
                </span>
            </div>
        </div>
        
        {% if document.is_pdf %}
        <div class="pdf-toolbar">
            <button id="prev-page">◀</button>
            <span>Pagina <span id="page-num"></span> / <span id="page-count"></span></span>
            <button id="next-page">▶</button>
            <button id="zoom-in">+</button>
            <button id="zoom-out">-</button>
        </div>
        {% endif %}

        {% if document.is_pdf %}
            <div id="pdf-viewer" style="width:100%; height:600px; overflow:auto;"></div>
            <p id="pdf-fallback" style="display:none;">
                No se puede visualizar el PDF.
                <a href="{{ document.file.url }}" target="_blank">Descargar PDF</a>
            </p>
        {% elif document.is_image %}
            <img src="{{ document.file.url }}" style="max-width:100%;" />
        {% else %}
            <p>No se puede visualizar el archivo</p>
        {% endif %}
    </div>
    <!-- Panel de datos con revisión editable -->
    <div class="data-form">
        <form method="post" id="review-form">
            {% csrf_token %}
            <div class="data">
    
                <!-- Proveedor -->
                <div class="field">
                    <span class="label">Proveedor</span>
                    {% if document.review_level in "required recommended" %}
                        <input type="text" name="provider_name" value="{{ document.provider_name }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.provider_name }}</span>
                    {% endif %}
                </div>
    
                <!-- CIF/NIF -->
                <div class="field">
                    <span class="label">CIF/NIF</span>
                    {% if document.review_level in "required recommended" %}
                        <input type="text" name="provider_tax_id" value="{{ document.provider_tax_id }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.provider_tax_id }}</span>
                    {% endif %}
                </div>
    
                <!-- Fecha -->
                <div class="field">
                    <span class="label">Fecha</span>
                    {% if document.review_level in "required recommended" %}
                        <input type="date" name="issue_date" value="{{ document.issue_date|date:'Y-m-d' }}" class="editable-field">
                    {% else %}
                        <span class="value">{{ document.issue_date|date:"d/m/Y" }}</span>
                    {% endif %}
                </div>
    
                <!-- Base -->
                <div class="field">
                    <span class="label">Base</span>
                    {% if document.review_level in "required recommended" %}
                        <input type="number" step="0.01" name="base_amount" value="{{ document.base_amount }}" class="editable-field">
                    {% else %}
                        <span class="value">{% if document.base_amount %}{{ document.base_amount }} €{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
    
                <!-- Cálculo IVA -->
                <div class="field">
                    <span class="label">Cálculo IVA</span>
                    {% if document.review_level in "required recommended" %}
                        <input type="number" step="0.01" name="tax_percentage" value="{{ document.tax_percentage }}" class="editable-field" placeholder="IVA %">
                        <input type="number" step="0.01" name="tax_amount" value="{{ document.tax_amount }}" class="editable-field" placeholder="IVA €">
                    {% else %}
                        <span class="value">
                            {% if document.base_amount and document.tax_percentage and document.tax_amount %}
                                {{ document.base_amount }} × {{ document.tax_percentage }}% = {{ document.tax_amount }} €
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
    
                <!-- Total -->
                <div class="field">
                    <span class="label">Total</span>
                    {% if document.review_level in "required recommended" %}
                        <input type="number" step="0.01" name="total_amount" value="{{ document.total_amount }}" class="editable-field">
                    {% else %}
                        <span class="value">{% if document.total_amount %}{{ document.total_amount }} €{% else %}-{% endif %}</span>
                    {% endif %}
                </div>
            </div>
        </form>
        <!-- Acciones -->
        <div class="actions">
            <!-- Formulario para guardar cambios de revisión -->
            {% if document.review_level in "required recommended" %}
            <form method="post" id="review-form">
                {% csrf_token %}
                <!-- campos editables aquí -->
                <button type="submit" class="btn-save">Guardar cambios</button>
            </form>
            {% endif %}
    
            <!-- Formulario para aprobar -->
            {% if document.status == 'pending' %}
            <form method="post" action="{% url 'documents:approve' document.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn-approve">Aprobar</button>
            </form>
    
            <form method="post" action="{% url 'documents:reject' document.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn-reject">Rechazar</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <script>
        const url = "{{ document.file.url }}";
        const container = document.getElementById('pdf-viewer');
        const fallback = document.getElementById('pdf-fallback');
        let pdfDoc = null, pageNum = 1; scale = 1.2;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Limpia container
                container.innerHTML = '';
                container.appendChild(canvas);

                page.render({ canvasContext: ctx, viewport: viewport });

                document.getElementById('page-num').textContent = pageNum;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
            });
        }

        pdfjsLib.getDocument(url).promise.then(pdf => {
            pdfDoc = pdf;
            renderPage(pageNum);
        });

        // Toolbar events
        document.getElementById('prev-page').onclick = () => { if(pageNum>1){ pageNum--; renderPage(pageNum); } };
        document.getElementById('next-page').onclick = () => { if(pageNum<pdfDoc.numPages){ pageNum++; renderPage(pageNum); } };
        document.getElementById('zoom-in').onclick = () => { scale+=0.2; renderPage(pageNum); };
        document.getElementById('zoom-out').onclick = () => { scale=Math.max(0.2, scale-0.2); renderPage(pageNum); };
    </script>
{% endblock %}